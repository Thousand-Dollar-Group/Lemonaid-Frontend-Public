name: Multi-Amplify Deploy

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          lfs: true   # enable Git LFS in checkout

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-1

      - name: Install Git LFS
        run: |
          curl -sSL https://github.com/git-lfs/git-lfs/releases/download/v3.5.1/git-lfs-linux-amd64-v3.5.1.tar.gz -o git-lfs.tar.gz
          tar -xzf git-lfs.tar.gz
          mv git-lfs-3.5.1 git-lfs-bin
          export PATH=$PATH:$(pwd)/git-lfs-bin
          git lfs install
          git lfs pull

      - name: Setup pnpm
        run: |
          npm install -g pnpm
          pnpm config set store-dir .pnpm-store
          pnpm install

      - name: Build frontend (staging)
        env:
          VITE_API_HOSTNAME: ${{ secrets.STAGING_API_HOSTNAME }}
          ENV: STAGING
        run: pnpm build

      - name: Zip build artifacts
        run: |
          cd dist
          zip -r ../build.zip .

      - name: Ensure no active deployment (staging)
        run: |
          ACTIVE_JOB=$(aws amplify list-jobs \
            --app-id ${{ secrets.AMPLIFY_APP_ID_STAGING }} \
            --branch-name main \
            --max-items 1 \
            --query 'jobSummaries[0].jobId' \
            --output text || echo "None")

          if [ "$ACTIVE_JOB" != "None" ] && [ -n "$ACTIVE_JOB" ]; then
            STATUS=$(aws amplify get-job \
              --app-id ${{ secrets.AMPLIFY_APP_ID_STAGING }} \
              --branch-name main \
              --job-id $ACTIVE_JOB \
              --query 'job.summary.status' \
              --output text || echo "UNKNOWN")

            echo "Latest job: $ACTIVE_JOB (status: $STATUS)"
            if [ "$STATUS" = "PENDING" ] || [ "$STATUS" = "RUNNING" ]; then
              echo "Stopping unfinished job $ACTIVE_JOB..."
              aws amplify stop-job \
                --app-id ${{ secrets.AMPLIFY_APP_ID_STAGING }} \
                --branch-name main \
                --job-id $ACTIVE_JOB
            fi
          else
            echo "No active jobs found."
          fi

      - name: Create deployment (staging)
        id: createdeployment
        run: |
          RESPONSE=$(aws amplify create-deployment \
            --app-id ${{ secrets.AMPLIFY_APP_ID_STAGING }} \
            --branch-name main)

          echo "$RESPONSE" > response.json
          JOB_ID=$(jq -r '.jobId' response.json)
          UPLOAD_URL=$(jq -r '.zipUploadUrl' response.json)

          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT

      - name: Upload build.zip to Amplify
        run: |
          curl -X PUT \
            -H "Content-Type: application/zip" \
            --upload-file build.zip \
            "${{ steps.createdeployment.outputs.upload_url }}"

      - name: Start deployment (staging)
        run: |
          aws amplify start-deployment \
            --app-id ${{ secrets.AMPLIFY_APP_ID_STAGING }} \
            --branch-name main \
            --job-id ${{ steps.createdeployment.outputs.job_id }}

  deploy-prod:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: deploy-staging
    steps:
      - uses: actions/checkout@v3
        with:
          lfs: true

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-1

      - name: Install Git LFS
        run: |
          curl -sSL https://github.com/git-lfs/git-lfs/releases/download/v3.5.1/git-lfs-linux-amd64-v3.5.1.tar.gz -o git-lfs.tar.gz
          tar -xzf git-lfs.tar.gz
          mv git-lfs-3.5.1 git-lfs-bin
          export PATH=$PATH:$(pwd)/git-lfs-bin
          git lfs install
          git lfs pull

      - name: Setup pnpm
        run: |
          npm install -g pnpm
          pnpm config set store-dir .pnpm-store
          pnpm install

      - name: Build frontend (prod)
        env:
          VITE_API_HOSTNAME: ${{ secrets.PROD_API_HOSTNAME }}
          ENV: PROD
        run: pnpm build

      - name: Zip build artifacts
        run: |
          cd dist
          zip -r ../build.zip .

      - name: Ensure no active deployment (prod)
        run: |
          ACTIVE_JOB=$(aws amplify list-jobs \
            --app-id ${{ secrets.AMPLIFY_APP_ID_PROD }} \
            --branch-name main \
            --max-items 1 \
            --query 'jobSummaries[0].jobId' \
            --output text || echo "None")

          if [ "$ACTIVE_JOB" != "None" ] && [ -n "$ACTIVE_JOB" ]; then
            STATUS=$(aws amplify get-job \
              --app-id ${{ secrets.AMPLIFY_APP_ID_PROD }} \
              --branch-name main \
              --job-id $ACTIVE_JOB \
              --query 'job.summary.status' \
              --output text || echo "UNKNOWN")

            echo "Latest job: $ACTIVE_JOB (status: $STATUS)"
            if [ "$STATUS" = "PENDING" ] || [ "$STATUS" = "RUNNING" ]; then
              echo "Stopping unfinished job $ACTIVE_JOB..."
              aws amplify stop-job \
                --app-id ${{ secrets.AMPLIFY_APP_ID_PROD }} \
                --branch-name main \
                --job-id $ACTIVE_JOB
            fi
          else
            echo "No active jobs found."
          fi

      - name: Create deployment (prod)
        id: createdeployment
        run: |
          RESPONSE=$(aws amplify create-deployment \
            --app-id ${{ secrets.AMPLIFY_APP_ID_PROD }} \
            --branch-name main)

          echo "$RESPONSE" > response.json
          JOB_ID=$(jq -r '.jobId' response.json)
          UPLOAD_URL=$(jq -r '.zipUploadUrl' response.json)

          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT

      - name: Upload build.zip to Amplify
        run: |
          curl -X PUT \
            -H "Content-Type: application/zip" \
            --upload-file build.zip \
            "${{ steps.createdeployment.outputs.upload_url }}"

      - name: Start deployment (prod)
        run: |
          aws amplify start-deployment \
            --app-id ${{ secrets.AMPLIFY_APP_ID_PROD }} \
            --branch-name main \
            --job-id ${{ steps.createdeployment.outputs.job_id }}
